# 前端代码修改说明：改为使用后端OCR接口

## 需要修改的文件

请在**小程序前端项目**中找到以下文件并修改：
- `utils/aiService.js` 或类似的AI服务文件

## 具体修改步骤

### 步骤1：找到 `callBaiduOCR` 函数

在小程序的 `aiService.js` 或相关文件中找到类似这样的函数：

```javascript
async callBaiduOCR(imageUrl) {
  // 原来的代码...
}
```

### 步骤2：将函数替换为以下代码

```javascript
/**
 * 调用后端OCR接口
 * @param {string} imageUrl - 图片路径
 * @returns {Promise<string>} 识别的文本
 */
async callBaiduOCR(imageUrl) {
  try {
    console.log('开始调用后端OCR接口');
    
    // 1. 获取用户token
    const token = uni.getStorageSync('token');
    if (!token) {
      console.error('用户未登录或Token无效');
      throw new Error('用户未登录或Token无效，无法调用OCR');
    }

    // 2. 将图片转换为base64
    console.log('正在将图片转换为base64...');
    const base64Image = await this.imageToBase64(imageUrl);
    
    if (!base64Image) {
      throw new Error('图片转换失败');
    }

    // 3. 调用后端接口
    console.log('正在调用后端OCR接口...');
    const response = await uni.request({
      url: `${this.baseURL || 'http://localhost:3000/api/v1'}/images/upload`,
      method: 'POST',
      header: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      data: {
        image: base64Image,
        doOCR: true  // 告诉后端需要进行OCR识别
      }
    });

    // 4. 检查响应
    if (response.statusCode === 200 && response.data.success) {
      const ocrResult = response.data.data.ocrResult;
      
      if (ocrResult && ocrResult.text) {
        console.log('OCR识别成功:', ocrResult.text);
        return ocrResult.text;
      } else {
        throw new Error('OCR识别结果为空');
      }
    } else {
      throw new Error(response.data.message || 'OCR识别失败');
    }
  } catch (error) {
    console.error('调用后端OCR失败:', error);
    throw error;
  }
}

/**
 * 将图片转换为base64格式
 * @param {string} filePath - 图片路径
 * @returns {Promise<string>} base64字符串
 */
imageToBase64(filePath) {
  return new Promise((resolve, reject) => {
    uni.getFileSystemManager().readFile({
      filePath: filePath,
      encoding: 'base64',
      success: (res) => {
        // 移除可能的data:image前缀
        let base64 = res.data;
        base64 = base64.replace(/^data:image\/\w+;base64,/, '');
        resolve(base64);
      },
      fail: (err) => {
        console.error('读取文件失败:', err);
        reject(err);
      }
    });
  });
}
```

### 步骤3：确保baseURL配置正确

找到配置文件（可能是 `config.js` 或 `utils/config.js`），确保包含：

```javascript
const config = {
  baseURL: 'http://localhost:3000/api/v1',  // 开发环境
  // 或者
  baseURL: 'http://10.10.12.20:3000/api/v1',  // 你的服务器地址
};
```

### 步骤4：测试

1. 保存文件
2. 重新编译小程序
3. 测试图片识别功能
4. 查看控制台是否有错误

## 注意事项

1. **网络地址**：确保后端服务器地址正确
2. **跨域问题**：开发环境可能需要配置跨域，但小程序不受跨域限制
3. **认证**：确保用户已登录，有有效的token
4. **图片大小**：建议限制图片大小，避免传输过大

## 错误排查

### 问题1：接口返回401
- 检查token是否有效
- 重新登录获取新token

### 问题2：图片转换失败
- 检查图片路径是否正确
- 确保有文件读取权限

### 问题3：OCR识别失败
- 查看后端日志
- 检查百度云OCR配置是否正确

## 完成后

修改完成后，你将获得：
- ✅ 更安全的API密钥管理
- ✅ 更好的成本控制
- ✅ 更规范的架构设计
