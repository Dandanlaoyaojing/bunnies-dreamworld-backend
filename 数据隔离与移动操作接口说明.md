# 数据隔离与移动操作接口说明

## 接口概述

本系统采用**完全数据隔离**的设计原则，将笔记数据分为三个独立的存储空间，并通过**移动而非复制**的操作方式实现数据流转。

---

## 一、数据隔离原则

### 1.1 三个独立的数据存储空间

#### 📝 常规笔记（笔记簿）
- **接口**: `GET /api/v1/notes`
- **存储**: 独立的 `notes` 表或集合
- **数据要求**: 
  - ✅ 只包含活跃的常规笔记
  - ❌ **不包含** `status === 'deleted'` 的笔记
  - ❌ **不包含** `isDeleted === true` 的笔记
  - ❌ **不包含** `isDraft === true` 的笔记
  - ❌ **不包含** `status === 'draft'` 的笔记
- **用途**: 笔记簿、知识星图、梦之国度等应用的唯一数据源

#### 📦 草稿箱
- **接口**: `GET /api/v1/drafts`
- **存储**: 独立的 `drafts` 表或集合
- **数据要求**: 
  - ✅ 只包含草稿数据
  - ❌ **不包含**常规笔记
  - ❌ **不包含**已删除笔记
- **用途**: 草稿箱功能专用

#### 🗑️ 回收站
- **接口**: `GET /api/v1/notes/trash/list`
- **存储**: 独立的 `trash` 表，或通过 `status === 'deleted'` 标记
- **数据要求**: 
  - ✅ 只包含已删除的笔记
  - ❌ **不包含**常规笔记
  - ❌ **不包含**草稿
- **用途**: 回收站功能专用

### 1.2 数据隔离验证

后端API必须确保：
- `/notes` 返回的数据中，**绝对不包含**草稿和已删除笔记
- `/drafts` 返回的数据中，**绝对不包含**常规笔记和已删除笔记
- `/notes/trash/list` 返回的数据中，**绝对不包含**常规笔记和草稿

---

## 二、移动操作接口（移动而非复制）

### 2.1 删除笔记 → 移到回收站

**接口**: `DELETE /api/v1/notes/{id}`  
**认证要求**: 需要认证

#### 功能说明
将笔记从常规笔记列表移动到回收站。**这是移动操作，不是复制**。

#### 请求格式
```http
DELETE /api/v1/notes/123
Authorization: Bearer {token}
```

#### 响应格式

**成功响应**:
```json
{
  "success": true,
  "message": "笔记已移到回收站",
  "data": {
    "noteId": 123,
    "moved": true
  }
}
```

#### 操作要求

1. ✅ **从常规笔记列表移除**
   - 从 `notes` 表中删除该记录，或
   - 将 `status` 字段设置为 `'deleted'`

2. ✅ **添加到回收站**
   - 如果使用独立 `trash` 表：将笔记添加到 `trash` 表
   - 如果使用状态标记：确保该笔记可以通过 `/notes/trash/list` 查询到

3. ❌ **不允许**在常规笔记列表中保留该笔记

#### 验证步骤

操作完成后，验证：
```javascript
// 1. 验证不在常规笔记列表中
GET /api/v1/notes
// 结果：不包含 id=123 的笔记

// 2. 验证在回收站中
GET /api/v1/notes/trash/list
// 结果：包含 id=123 的笔记
```

---

### 2.2 恢复笔记 → 移到常规笔记库

**接口**: `POST /api/v1/notes/{id}/restore`  
**认证要求**: 需要认证

#### 功能说明
将笔记从回收站恢复到常规笔记列表。**这是移动操作，不是复制**。

#### 请求格式
```http
POST /api/v1/notes/123/restore
Authorization: Bearer {token}
```

#### 响应格式

**成功响应**:
```json
{
  "success": true,
  "message": "笔记已恢复",
  "data": {
    "noteId": 123,
    "restored": true,
    "note": {
      "id": 123,
      "title": "笔记标题",
      "status": "active",
      // ... 其他字段
    }
  }
}
```

#### 操作要求

1. ✅ **从回收站移除**
   - 从 `trash` 表中删除该记录，或
   - 将 `status` 字段从 `'deleted'` 改为 `'active'`

2. ✅ **添加到常规笔记列表**
   - 添加到 `notes` 表
   - 清除所有删除相关标记：
     - `status` 不能是 `'deleted'`
     - `isDeleted` 必须是 `false`
     - 删除 `deleteTime` 字段

3. ❌ **不允许**在回收站中保留该笔记

#### 验证步骤

操作完成后，验证：
```javascript
// 1. 验证不在回收站中
GET /api/v1/notes/trash/list
// 结果：不包含 id=123 的笔记

// 2. 验证在常规笔记列表中
GET /api/v1/notes/123
// 结果：可以获取到 id=123 的笔记，且 status !== 'deleted'
```

---

### 2.3 发布草稿 → 移到常规笔记库

**接口**: `POST /api/v1/drafts/{id}/publish`  
**认证要求**: 需要认证

#### 功能说明
将草稿发布为常规笔记。**这是移动操作，不是复制**。

#### 请求格式
```http
POST /api/v1/drafts/456/publish
Authorization: Bearer {token}
```

#### 响应格式

**成功响应**:
```json
{
  "success": true,
  "message": "草稿已发布为笔记",
  "data": {
    "draftId": 456,
    "noteId": 789,
    "note": {
      "id": 789,
      "title": "笔记标题",
      "content": "笔记内容",
      "isDraft": false,
      // ... 其他字段
    }
  }
}
```

#### 操作要求

1. ✅ **从草稿箱移除**
   - 从 `drafts` 表中**删除**该草稿记录

2. ✅ **创建为常规笔记**
   - 在 `notes` 表中创建新记录
   - 确保 `isDraft === false`
   - 确保 `status !== 'draft'`

3. ❌ **不允许**在草稿箱中保留该草稿

#### 验证步骤

操作完成后，验证：
```javascript
// 1. 验证不在草稿箱中
GET /api/v1/drafts
// 结果：不包含 id=456 的草稿

// 2. 验证在常规笔记列表中
GET /api/v1/notes/789
// 结果：可以获取到 id=789 的笔记，且 isDraft === false
```

---

### 2.4 彻底删除 → 从回收站删除

**接口**: `DELETE /api/v1/notes/{id}/permanent`  
**认证要求**: 需要认证

#### 功能说明
从回收站彻底删除笔记。**这是真正的删除操作，不再保留**。

#### 请求格式
```http
DELETE /api/v1/notes/123/permanent
Authorization: Bearer {token}
```

#### 响应格式

**成功响应**:
```json
{
  "success": true,
  "message": "笔记已彻底删除",
  "data": {
    "noteId": 123,
    "deleted": true
  }
}
```

#### 操作要求

1. ✅ **从回收站删除**
   - 从 `trash` 表中**彻底删除**该记录，或
   - 从数据库中**物理删除**该记录

2. ❌ **不允许**在任何地方保留该笔记（真正的删除）

---

### 2.5 删除草稿 → 从草稿箱删除

**接口**: `DELETE /api/v1/drafts/{id}`  
**认证要求**: 需要认证

#### 功能说明
从草稿箱删除草稿。**这是真正的删除操作，不再保留**。

#### 请求格式
```http
DELETE /api/v1/drafts/456
Authorization: Bearer {token}
```

#### 响应格式

**成功响应**:
```json
{
  "success": true,
  "message": "草稿已删除",
  "data": {
    "draftId": 456,
    "deleted": true
  }
}
```

#### 操作要求

1. ✅ **从草稿箱删除**
   - 从 `drafts` 表中**彻底删除**该记录

2. ❌ **不允许**在任何地方保留该草稿（真正的删除）

---

## 三、关键原则

### 3.1 移动而非复制

- ✅ 所有操作都应该是**移动**（move），不是**复制**（copy）
- ✅ 数据从一个存储空间移动到另一个存储空间时，**必须从源位置删除**
- ❌ **不允许**数据同时存在于多个存储空间

### 3.2 数据一致性

- 前端调用后端API后，会根据后端返回的结果更新本地存储
- 后端API的行为必须与前端期望一致，确保数据在前后端都保持一致
- 建议后端在操作后返回更新后的数据，方便前端验证

### 3.3 原子性操作

- 移动操作应该是原子性的：要么全部成功，要么全部失败
- 如果从源位置删除成功但添加到目标位置失败，应该回滚操作

---

## 四、接口对比表

| 操作 | 接口 | 源位置 | 目标位置 | 操作类型 |
|------|------|--------|----------|---------|
| 删除笔记 | `DELETE /notes/{id}` | 常规笔记库 | 回收站 | 移动 |
| 恢复笔记 | `POST /notes/{id}/restore` | 回收站 | 常规笔记库 | 移动 |
| 发布草稿 | `POST /drafts/{id}/publish` | 草稿箱 | 常规笔记库 | 移动 |
| 彻底删除 | `DELETE /notes/{id}/permanent` | 回收站 | 无（删除） | 删除 |
| 删除草稿 | `DELETE /drafts/{id}` | 草稿箱 | 无（删除） | 删除 |

---

## 五、注意事项

1. **数据隔离是强制的**：三个存储空间的数据绝对不能混合
2. **移动操作是必须的**：所有跨存储空间的操作都必须是移动，不能是复制
3. **验证是必要的**：操作后应该验证数据确实从源位置移除
4. **错误处理是关键的**：如果移动失败，应该回滚到原始状态

---

## 六、最佳实践

1. **操作顺序**：先删除源位置，再添加到目标位置（或使用事务）
2. **错误处理**：如果添加到目标位置失败，应该恢复源位置的数据
3. **返回数据**：建议返回操作后的完整数据，方便前端验证
4. **日志记录**：记录所有移动操作，方便排查问题

---

## 七、故障排查

### 问题：笔记同时存在于两个存储空间

**可能原因**：
- 移动操作只执行了一半（只添加，没删除）
- 数据库事务回滚失败

**解决方法**：
- 检查操作日志
- 验证数据完整性
- 执行数据清理脚本

### 问题：笔记无法恢复

**可能原因**：
- 笔记在回收站中不存在
- 恢复操作失败但没有报错

**解决方法**：
- 检查回收站中是否存在该笔记
- 查看后端日志
- 验证恢复接口的返回值

---

## 📄 相关文档

- `前端-数据隔离与移动操作更新说明.md` - 前端更新指南
- `数据隔离与移动操作问题诊断与修复.md` - 问题分析和修复说明

---

## 🎯 总结

**核心原则**：
1. **数据隔离**：三个存储空间完全独立，互不干扰
2. **移动操作**：所有跨存储空间的操作都是移动，不是复制
3. **数据一致性**：前后端行为一致，确保数据正确流转


