# 前端代码修改详细步骤

## 📁 目标文件位置
```
C:\Users\Administrator\WeChatProjects\miniprogram-4
```

## 🎯 需要找到的文件
1. `utils/aiService.js` - AI服务和OCR服务
2. `config.js` 或类似的配置文件

## 🔧 配置总结

### 后端已配置：
- ✅ DeepSeek API: `sk-7f977e073d1a431caf8a7b87674fd22a`
- ✅ 百度云OCR: `e8Hf2GgRQX9N3RRqj1uv6Ylb` / `PQkWjyyr8OLaRSiK1ryTzh9LfjBIPn7n`

### 前端需要修改：
- ❌ 目前前端直接调用百度OCR（失败）
- ❌ 需要改为调用后端接口

## 📝 修改步骤

### 步骤1：找到 `utils/aiService.js`

在 `C:\Users\Administrator\WeChatProjects\miniprogram-4\utils\aiService.js`

### 步骤2：找到 `callBaiduOCR` 函数

找到类似这样的代码：
```javascript
async callBaiduOCR(imageUrl) {
  // 原来的代码在这里
}
```

### 步骤3：替换为以下代码

```javascript
async callBaiduOCR(imageUrl) {
  try {
    console.log('🔄 开始调用后端OCR接口');
    
    // 1. 获取用户token
    const token = uni.getStorageSync('token');
    if (!token) {
      throw new Error('用户未登录');
    }

    // 2. 将图片转换为base64
    const base64Image = await this.imageToBase64(imageUrl);
    
    if (!base64Image) {
      throw new Error('图片转换失败');
    }

    // 3. 调用后端接口
    const response = await uni.request({
      url: 'http://localhost:3000/api/v1/images/upload',
      method: 'POST',
      header: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      data: {
        image: base64Image,
        doOCR: true
      }
    });

    // 4. 处理响应
    if (response.statusCode === 200 && response.data.success && response.data.data.ocrResult) {
      console.log('✅ OCR识别成功');
      return response.data.data.ocrResult.text;
    }
    
    throw new Error('OCR识别失败');
  } catch (error) {
    console.error('OCR识别失败:', error);
    throw error;
  }
}

// 添加图片转base64方法
imageToBase64(filePath) {
  return new Promise((resolve, reject) => {
    uni.getFileSystemManager().readFile({
      filePath: filePath,
      encoding: 'base64',
      success: (res) => {
        const base64 = res.data.replace(/^data:image\/\w+;base64,/, '');
        resolve(base64);
      },
      fail: reject
    });
  });
}
```

### 步骤4：保存并测试

1. 保存文件
2. 重新编译小程序
3. 测试图片识别功能

## ⚠️ 注意事项

### 后端服务器地址
确保小程序能访问：
- 开发环境：`http://localhost:3000`
- 如果小程序无法访问localhost，使用你的本机IP：`http://10.10.12.20:3000`

修改代码中的URL为你的实际后端地址。

## ✅ 预期效果

修改后：
- ✅ 图片识别通过后端调用百度OCR
- ✅ 不会再有 "unsupported_grant_type" 错误
- ✅ API密钥更安全（不暴露在前端）

## 📞 如果遇到问题

1. 确保后端服务器正在运行
2. 确保用户已登录
3. 检查网络连接
4. 查看控制台错误信息

