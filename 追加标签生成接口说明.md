# 追加标签生成接口说明

## 接口信息

**接口路径**: `POST /api/v1/ai/append-tags`  
**认证要求**: 可选认证（可选）

## 功能说明

使用 DeepSeek AI 为笔记追加生成新标签，**自动排除已有标签**，避免重复生成。

### 特点

1. ✅ **使用 DeepSeek AI** - 智能生成新标签
2. ✅ **自动去重** - 不会生成与已有标签相同或相似的标签
3. ✅ **提示词优化** - AI提示词中明确告知已有标签，要求不重复生成
4. ✅ **双重过滤** - AI生成后还会进行后端过滤，确保不重复
5. ✅ **向后兼容** - 与首次生成使用相同的逻辑，只是增加了排除已有标签的功能

## 请求格式

```json
{
  "content": "笔记内容...",
  "category": "knowledge",
  "existingTags": ["标签1", "标签2", "标签3"]
}
```

### 参数说明

- `content` (必需): 笔记内容
- `category` (可选): 笔记分类，默认 "knowledge"
- `existingTags` (可选): 已有标签数组，用于排除重复

## 响应格式

### 成功响应（有新标签）

```json
{
  "success": true,
  "message": "成功追加 3 个新标签",
  "data": {
    "tags": ["新标签1", "新标签2", "新标签3"],
    "tagList": ["新标签1", "新标签2", "新标签3"],
    "result": ["新标签1", "新标签2", "新标签3"],
    "existingTags": ["标签1", "标签2", "标签3"],
    "appendedCount": 3
  }
}
```

### 成功响应（无新标签）

```json
{
  "success": true,
  "message": "未生成新标签（可能已覆盖所有相关内容）",
  "data": {
    "tags": [],
    "tagList": [],
    "result": [],
    "existingTags": ["标签1", "标签2", "标签3"],
    "appendedCount": 0
  }
}
```

### 错误响应

```json
{
  "success": false,
  "error": "请提供笔记内容"
}
```

## 去重逻辑

### 1. AI层面去重

在提示词中明确告知AI已有标签，要求不重复生成：

```
已有标签（请不要重复生成）：标签1、标签2、标签3
```

### 2. 后端过滤去重

即使AI返回了重复标签，后端也会进行二次过滤：

- **完全相同**：`existing === tagLower`
- **包含关系**：`existing.includes(tagLower)` 或 `tagLower.includes(existing)`

确保不返回与已有标签相同或相似的标签。

## 使用示例

### 前端调用示例

```javascript
// 追加标签生成
async function appendTags(content, existingTags) {
  try {
    const response = await wx.request({
      url: 'https://your-api-domain.com/api/v1/ai/append-tags',
      method: 'POST',
      header: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}` // 如果需要认证
      },
      data: {
        content: content,
        category: 'knowledge',
        existingTags: existingTags // 传入已有标签数组
      }
    });
    
    if (response.data.success) {
      const newTags = response.data.data.tags;
      const appendedCount = response.data.data.appendedCount;
      
      if (appendedCount > 0) {
        console.log(`成功追加 ${appendedCount} 个新标签:`, newTags);
        // 合并到现有标签
        return [...existingTags, ...newTags];
      } else {
        console.log('未生成新标签');
        return existingTags;
      }
    }
  } catch (error) {
    console.error('追加标签生成失败:', error);
    return existingTags; // 失败时返回原有标签
  }
}
```

## 与首次生成的对比

| 特性 | 首次生成 (`/generate-tags`) | 追加生成 (`/append-tags`) |
|------|---------------------------|-------------------------|
| 参数 | `content`, `category` | `content`, `category`, `existingTags` |
| 去重 | 仅自身去重 | 排除已有标签 + 自身去重 |
| AI提示词 | 标准提示词 | 包含"已有标签"的提示词 |
| 返回字段 | `tags`, `tagList` 等 | `tags`, `tagList`, `existingTags`, `appendedCount` |
| 使用场景 | 首次生成标签 | 追加生成新标签 |

## 注意事项

1. **必须传递已有标签**: 如果不传递 `existingTags` 或传递空数组，功能等同于首次生成
2. **大小写不敏感**: 去重检查不区分大小写
3. **包含关系过滤**: 不仅检查完全相同，还检查包含关系（如"学习"会过滤掉"学习笔记"）
4. **AI可能无新标签**: 如果内容的所有关键点都已被现有标签覆盖，可能返回空数组
5. **温度设置**: 追加生成时温度设为0.8（略高于首次生成的0.7），以便生成更多样化的标签

## 故障排查

### 问题：追加生成时没有新标签

**可能原因**：
1. 已有标签已覆盖所有关键内容
2. AI返回的标签都被过滤掉了
3. 内容太短，没有足够信息生成新标签

**解决方法**：
- 检查返回的 `appendedCount` 字段
- 如果为0，说明确实没有新标签可生成（这是正常情况）
- 可以尝试增加笔记内容，或手动添加标签

### 问题：仍然生成了重复标签

**可能原因**：
1. 标签名称相似但不同（如"学习"和"学习方法"）
2. AI没有理解去重要求

**解决方法**：
- 检查后端日志中的 `🎯 成功追加生成AI标签` 输出
- 如果仍有重复，检查过滤逻辑是否正常工作

## 最佳实践

1. **前端调用**: 点击"追加生成"时，传递当前所有标签到 `existingTags`
2. **合并标签**: 收到新标签后，直接合并到现有标签数组
3. **显示提示**: 如果 `appendedCount` 为0，可以提示用户"未生成新标签"
4. **限制次数**: 建议限制追加生成次数，避免用户无限追加

