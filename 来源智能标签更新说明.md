# 来源智能标签更新说明

## 📋 更新内容

为避免与笔记的 `source` 字段（出处）产生歧义，已将来源智能标签的标识从 `source` 改为 `origin`。

---

## 🔄 术语更新

### 修改前
- 标签 `source` 字段值：`'source'`（容易与笔记的 `source` 字段混淆）

### 修改后
- 标签 `source` 字段值：`'origin'`（清晰表示"从笔记出处字段生成的智能标签"）

---

## 📊 标签类型说明

| 类型 | source 值 | 颜色 | 说明 |
|------|----------|------|------|
| **手动标签** | `'manual'` | 紫色 (#9C27B0) | 用户手动添加的标签 |
| **AI生成标签** | `'ai'` | 蓝色 (#007AFF) | 基于笔记内容AI生成的标签 |
| **出处智能标签** | `'origin'` | 玫红色 (#FF1493) | 从笔记出处字段（source字段）智能生成的标签 |

---

## ✅ 功能一致性

**所有标签功能完全一致**，无论 source 值是什么：

- ✅ **搜索功能**：按标签名称搜索，不区分 source
- ✅ **列表功能**：所有标签统一列出，不区分 source
- ✅ **统计功能**：统一统计使用次数，不区分 source
- ✅ **筛选功能**：统一筛选功能，不区分 source
- ✅ **数据归属**：所有标签统一存储在 `tags` 表中
- ✅ **关联关系**：通过 `note_tags` 表关联到笔记

**仅在呈现上有颜色区分**：
- 🟣 手动标签：紫色
- 🔵 AI标签：蓝色
- 🌹 出处智能标签：玫红色

---

## 🔧 数据库更新

### 迁移脚本更新

**文件**: `add_tag_source_field.sql`

```sql
ALTER TABLE note_tags 
ADD COLUMN source ENUM('manual', 'ai', 'origin') DEFAULT 'ai' 
COMMENT '标签来源：manual-手动添加，ai-AI生成，origin-从笔记出处字段生成的智能标签';
```

### 已更新的代码

1. **`src/routes/ai.js`** - 来源标签生成接口
   - 返回的标签中 `source: 'origin'`
   - 颜色：`#FF1493`（玫红色）

2. **`src/controllers/noteController.js`** - 笔记控制器
   - `normalizeTag()` 函数支持 `'origin'` 类型
   - `attachTags()` 函数支持存储 `'origin'` 类型标签

3. **`src/routes/draft.js`** - 草稿路由
   - `normalizeTag()` 函数支持 `'origin'` 类型

---

## 📝 API 使用示例

### 生成出处智能标签

**接口**: `POST /api/v1/ai/generate-source-tags`

**请求**:
```json
{
  "source": "《深入理解计算机系统》作者：Randal E. Bryant, David R. O'Hallaron 机械工业出版社"
}
```

**响应**:
```json
{
  "code": 200,
  "data": {
    "tags": [
      {
        "name": "Randal E. Bryant",
        "type": "author",
        "source": "origin",
        "color": "#FF1493"
      },
      {
        "name": "深入理解计算机系统",
        "type": "book",
        "source": "origin",
        "color": "#FF1493"
      },
      {
        "name": "机械工业出版社",
        "type": "publisher",
        "source": "origin",
        "color": "#FF1493"
      }
    ]
  }
}
```

### 创建笔记（包含出处智能标签）

**接口**: `POST /api/v1/notes`

**请求**:
```json
{
  "title": "计算机系统学习笔记",
  "content": "笔记内容...",
  "source": "《深入理解计算机系统》作者：Randal E. Bryant",
  "tags": [
    {"name": "Randal E. Bryant", "source": "origin"},
    {"name": "深入理解计算机系统", "source": "origin"},
    {"name": "学习", "source": "manual"}
  ]
}
```

---

## 🎨 前端显示建议

### 颜色映射

```javascript
const getTagColor = (source) => {
  switch(source) {
    case 'manual':
      return '#9C27B0'; // 紫色
    case 'ai':
      return '#007AFF'; // 蓝色
    case 'origin':
      return '#FF1493'; // 玫红色
    default:
      return '#007AFF'; // 默认蓝色
  }
};
```

### CSS 类名

```css
.tag-manual {
  background-color: #9C27B0;
  color: white;
}

.tag-ai {
  background-color: #007AFF;
  color: white;
}

.tag-origin {
  background-color: #FF1493; /* 玫红色 */
  color: white;
}
```

---

## ⚠️ 注意事项

1. **术语清晰**：
   - `origin` = 从笔记出处字段生成的智能标签
   - 笔记的 `source` 字段 = 笔记的出处信息（书籍、文章等）
   - 两者不再混淆

2. **向后兼容**：
   - 如果接收到旧的 `source: 'source'`，会自动转换为 `source: 'ai'`
   - 新数据统一使用 `source: 'origin'`

3. **功能一致性**：
   - 所有标签在搜索、列表、统计等功能上完全一致
   - 仅在视觉呈现上有颜色区分

---

## 📄 相关文档

- `后端-标签Source字段支持说明.md` - 标签功能技术文档
- `标签功能统一性说明.md` - 标签功能统一性说明
- `add_tag_source_field.sql` - 数据库迁移脚本

---

## ✅ 更新完成

- ✅ 数据库枚举类型已更新（`'origin'`）
- ✅ 来源标签生成接口已更新
- ✅ 标签规范化函数已更新
- ✅ 标签存储和查询功能已更新
- ✅ 避免与笔记 `source` 字段产生歧义

