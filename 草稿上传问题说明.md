# 草稿上传问题说明

## 问题描述

```
❌ 草稿上传失败: TypeError: apiService.createDraft is not a function
```

## 原因分析

前端调用了不存在的函数 `apiService.createDraft`，但后端提供的接口是：
- `POST /api/v1/drafts` - 创建/保存草稿

## 后端已有接口

### 可用的草稿接口

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | `/api/v1/drafts` | 获取草稿列表 |
| GET | `/api/v1/drafts/:id` | 获取草稿详情 |
| **POST** | **`/api/v1/drafts`** | **保存草稿** ✅ |
| PUT | `/api/v1/drafts/:id` | 更新草稿 |
| DELETE | `/api/v1/drafts/:id` | 删除草稿 |
| POST | `/api/v1/drafts/:id/publish` | 发布草稿为笔记 |

### 保存草稿接口详情

**请求示例**：
```javascript
POST http://10.10.12.20:3000/api/v1/drafts
Authorization: Bearer {token}
Content-Type: application/json

{
  "title": "草稿标题",
  "content": "草稿内容",
  "category": "knowledge",
  "tags": ["标签1", "标签2"]
}
```

**响应示例**：
```json
{
  "success": true,
  "message": "草稿保存成功",
  "data": {
    "id": 123,
    "word_count": 100
  }
}
```

## 前端需要修改

### 文件位置
`C:\Users\Administrator\WeChatProjects\miniprogram-4`

### 需要修改的文件
- `utils/apiService.js` - API服务文件
- `services/draftCloudService.js` - 草稿云服务

### 添加的方法

在 `apiService.js` 中添加：

```javascript
// 创建/保存草稿
createDraft(draftData) {
  return uni.request({
    url: `${this.baseURL}/drafts`,
    method: 'POST',
    header: {
      'Authorization': `Bearer ${this.getToken()}`,
      'Content-Type': 'application/json'
    },
    data: {
      title: draftData.title || '',
      content: draftData.content || '',
      category: draftData.category || 'knowledge',
      tags: draftData.tags || []
    }
  });
}

// 更新草稿
updateDraft(draftId, draftData) {
  return uni.request({
    url: `${this.baseURL}/drafts/${draftId}`,
    method: 'PUT',
    header: {
      'Authorization': `Bearer ${this.getToken()}`,
      'Content-Type': 'application/json'
    },
    data: {
      title: draftData.title || '',
      content: draftData.content || '',
      category: draftData.category || 'knowledge',
      tags: draftData.tags || []
    }
  });
}
```

## 修改步骤

### 步骤1: 打开 `apiService.js`

位置：`utils/apiService.js`

### 步骤2: 添加方法

在已有的方法后面添加 `createDraft` 和 `updateDraft` 方法。

### 步骤3: 确保方法导出

```javascript
export default {
  // ... 其他方法
  createDraft,
  updateDraft
}
```

### 步骤4: 在 `draftCloudService.js` 中使用

```javascript
// 导入apiService
import apiService from '@/utils/apiService';

// 上传草稿时调用
async uploadDraft(draftData) {
  try {
    const response = await apiService.createDraft(draftData);
    
    if (response.data.success) {
      return {
        success: true,
        id: response.data.data.id
      };
    }
    
    throw new Error(response.data.message || '草稿保存失败');
  } catch (error) {
    console.error('❌ 草稿上传失败:', error);
    throw error;
  }
}
```

## 错误处理

### 如果Token无效
- 401错误表示Token失效
- 需要重新登录获取新Token

### 如果网络失败
- 检查服务器是否运行
- 检查网络连接
- 检查URL配置是否正确

## 临时解决方案

如果不想修改前端代码，可以：

1. **使用本地存储**
   - 草稿可以先保存到本地
   - 等后端接口修复后再同步

2. **手动保存**
   - 暂时禁用自动保存
   - 手动触发保存操作

## 检查清单

- [ ] `apiService.js` 中是否定义了 `createDraft` 方法
- [ ] 方法是否正确导出
- [ ] `draftCloudService.js` 是否导入了 `apiService`
- [ ] API base URL 是否正确配置
- [ ] Token是否正确传递

## 预期结果

修改后，草稿上传应该：
- ✅ 成功保存到数据库
- ✅ 返回草稿ID
- ✅ 显示成功提示
- ✅ 不再出现 `is not a function` 错误

## 测试步骤

1. 打开笔记编辑页面
2. 输入内容
3. 等待自动保存（或手动保存）
4. 查看是否还有错误
5. 检查后端日志确认收到请求
